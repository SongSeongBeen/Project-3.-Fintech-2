<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>EasyPay - ë©”ì¸</title>
    <link rel="stylesheet" href="/css/common.css">
    <style>
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0 0 20px 20px;
            margin-bottom: 30px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .notification-icon {
            position: relative;
            cursor: pointer;
            font-size: 24px;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .notification-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .settings-icon {
            position: relative;
            cursor: pointer;
            font-size: 24px;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .settings-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* ì„¤ì • ë“œë¡­ë‹¤ìš´ ë©”ë‰´ */
        .settings-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1000;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        
        .settings-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .settings-dropdown::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 15px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }
        
        .settings-menu-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        .settings-menu-item:last-child {
            border-bottom: none;
        }
        
        .settings-menu-item:hover {
            background-color: #f8f9fa;
        }
        
        .settings-menu-item .icon {
            margin-right: 12px;
            font-size: 18px;
            width: 20px;
            text-align: center;
        }
        
        .settings-menu-item .text {
            font-size: 14px;
            font-weight: 500;
        }
        
        .settings-menu-item .description {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        /* PIN ì„¤ì • ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex !important;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            position: relative;
            animation: modalSlideUp 0.3s ease-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .pin-form-group {
            margin-bottom: 20px;
        }

        .pin-form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .pin-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            text-align: center;
            letter-spacing: 8px;
            box-sizing: border-box;
        }

        .pin-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .pin-input::placeholder {
            letter-spacing: normal;
            text-align: left;
        }

        .pin-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 6px;
            min-height: 18px;
        }

        .pin-success {
            color: #28a745;
            font-size: 12px;
            margin-top: 6px;
            min-height: 18px;
        }

        .modal-actions {
            padding: 0 20px 20px 20px;
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn-cancel {
            background: #f8f9fa;
            color: #6c757d;
        }

        .modal-btn-cancel:hover {
            background: #e9ecef;
            color: #5a6268;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-1px);
        }

        .modal-btn-primary:disabled {
            background: #d6d8db;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .pin-status-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .pin-status-info.has-pin {
            background: #d4edda;
            color: #155724;
        }

        .pin-status-info.no-pin {
            background: #fff3cd;
            color: #856404;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
        }
        
        .btn-small {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-small:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ê°œì¸ì •ë³´ ìˆ˜ì • í¼ ìŠ¤íƒ€ì¼ */
        .profile-form-group {
            margin-bottom: 20px;
        }

        .profile-form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .profile-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .profile-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .profile-error {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 4px;
            min-height: 16px;
        }

        .profile-error.success {
            color: #28a745;
        }

        .profile-error.error {
            color: #e74c3c;
        }

        .profile-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .profile-actions .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-actions .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .profile-actions .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .profile-actions .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e1e5e9;
        }

        .profile-actions .btn-secondary:hover {
            background: #e9ecef;
        }

        /* ì…ë ¥ í•„ë“œì™€ ë²„íŠ¼ì„ í•¨ê»˜ ë°°ì¹˜í•˜ëŠ” ìŠ¤íƒ€ì¼ */
        .input-with-button {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-with-button .profile-input {
            flex: 1;
        }

        .input-with-button .btn-small {
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .input-with-button .btn-small:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-1px);
        }

        /* readonly ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .profile-input[readonly] {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
    </style>
    <script defer src="/js/common.js"></script>
    <script defer src="/js/main.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>ğŸ¦ EasyPay</h1>
            </div>
            <div class="header-right">
                <div class="notification-icon" onclick="goToAlarm()">
                    ğŸ””
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </div>
                <div class="settings-icon" onclick="toggleSettings()">
                    âš™ï¸
                    <div class="settings-dropdown" id="settingsDropdown">
                        <div class="settings-menu-item" onclick="openAccountManagement()">
                            <span class="icon">ğŸ’³</span>
                            <div>
                                <div class="text">ê³„ì¢Œ ê´€ë¦¬</div>
                                <div class="description">ê³„ì¢Œ ìƒì„± ë° ì™¸ë¶€ ê³„ì¢Œ ì—°ê²°</div>
                            </div>
                        </div>
                        <div class="settings-menu-item" onclick="openPinSettings()">
                            <span class="icon">ğŸ”</span>
                            <div>
                                <div class="text">PIN ê´€ë¦¬</div>
                                <div class="description">PIN ë“±ë¡ ë° ë³€ê²½</div>
                            </div>
                        </div>
                        <div class="settings-menu-item" onclick="openAccountSettings()">
                            <span class="icon">ğŸ‘¤</span>
                            <div>
                                <div class="text">ê³„ì • ê´€ë¦¬</div>
                                <div class="description">ê°œì¸ì •ë³´ ìˆ˜ì •</div>
                            </div>
                        </div>
                        <div class="settings-menu-item" onclick="openSecuritySettings()">
                            <span class="icon">ğŸ›¡ï¸</span>
                            <div>
                                <div class="text">ë³´ì•ˆ ì„¤ì •</div>
                                <div class="description">ë¡œê·¸ì¸ ë³´ì•ˆ ê´€ë¦¬</div>
                            </div>
                        </div>
                    </div>
                </div>
    
                <button class="btn btn-small" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="main-content">
            <div class="welcome-section">
                <h2>ì•ˆë…•í•˜ì„¸ìš”! <span id="userName">ê³ ê°ë‹˜</span></h2>
                <p>ì–´ë–¤ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            </div>

            <div class="service-buttons">
                <button class="service-btn" onclick="goToTransfer()">
                    <div class="service-icon">ğŸ’¸</div>
                    <div class="service-text">ì†¡ê¸ˆí•˜ê¸°</div>
                </button>
                <button class="service-btn" onclick="goToPayment()">
                    <div class="service-icon">ğŸ’³</div>
                    <div class="service-text">ê²°ì œí•˜ê¸°</div>
                </button>
                <button class="service-btn" onclick="goToBalance()">
                    <div class="service-icon">ğŸ’°</div>
                    <div class="service-text">ì”ì•¡ì¡°íšŒ</div>
                </button>
            </div>

            <div class="quick-info">
                <div class="info-card">
                    <h3>ë‚´ ê³„ì¢Œë²ˆí˜¸</h3>
                    <p id="accountNumber">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PIN ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="pinModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="pinModalTitle">PIN ê´€ë¦¬</h3>
                <button class="modal-close" onclick="closePinModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="pin-status-info" id="pinStatusInfo">
                    PIN ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...
                </div>
                
                <!-- PIN ë“±ë¡ í¼ -->
                <div id="pinRegisterForm" style="display: none;">
                    <div class="pin-form-group">
                        <label class="pin-form-label" for="currentPassword">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="pin-input" id="currentPassword" 
                               placeholder="í˜„ì¬ ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="letter-spacing: normal; text-align: left;">
                        <div class="pin-error" id="currentPasswordError"></div>
                    </div>
                    <div class="pin-form-group">
                        <label class="pin-form-label" for="newPin">ìƒˆë¡œìš´ PIN (6ìë¦¬)</label>
                        <input type="password" class="pin-input" id="newPin" 
                               placeholder="6ìë¦¬ ìˆ«ì ì…ë ¥" maxlength="6">
                        <div class="pin-error" id="newPinError"></div>
                    </div>
                    <div class="pin-form-group">
                        <label class="pin-form-label" for="confirmPin">PIN í™•ì¸</label>
                        <input type="password" class="pin-input" id="confirmPin" 
                               placeholder="PIN ì¬ì…ë ¥" maxlength="6">
                        <div class="pin-error" id="confirmPinError"></div>
                    </div>
                </div>
                
                <!-- PIN ë³€ê²½ í¼ -->
                <div id="pinChangeForm" style="display: none;">
                    <div class="pin-form-group">
                        <label class="pin-form-label" for="currentPin">í˜„ì¬ PIN</label>
                        <input type="password" class="pin-input" id="currentPin" 
                               placeholder="í˜„ì¬ PIN ì…ë ¥" maxlength="6">
                        <div class="pin-error" id="currentPinError"></div>
                    </div>
                    <div class="pin-form-group">
                        <label class="pin-form-label" for="newPinChange">ìƒˆë¡œìš´ PIN (6ìë¦¬)</label>
                        <input type="password" class="pin-input" id="newPinChange" 
                               placeholder="6ìë¦¬ ìˆ«ì ì…ë ¥" maxlength="6">
                        <div class="pin-error" id="newPinChangeError"></div>
                    </div>
                    <div class="pin-form-group">
                        <label class="pin-form-label" for="confirmPinChange">PIN í™•ì¸</label>
                        <input type="password" class="pin-input" id="confirmPinChange" 
                               placeholder="PIN ì¬ì…ë ¥" maxlength="6">
                        <div class="pin-error" id="confirmPinChangeError"></div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="modal-btn modal-btn-primary" id="pinSubmitBtn" onclick="submitPin()">í™•ì¸</button>
                    <button class="modal-btn modal-btn-cancel" onclick="closePinModal()">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ê°œì¸ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ê°œì¸ì •ë³´ ìˆ˜ì •</h3>
                <button class="modal-close" onclick="closeProfileModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì„¹ì…˜ -->
                <div id="passwordCheckSection">
                    <div class="profile-form-group">
                        <label class="profile-form-label" for="profilePasswordCheck">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" class="profile-input" id="profilePasswordCheck" placeholder="ìˆ˜ì •ì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        <div class="profile-error" id="profilePasswordCheckError"></div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-primary" onclick="verifyPasswordForProfile()">í™•ì¸</button>
                        <button class="btn btn-secondary" onclick="closeProfileModal()">ì·¨ì†Œ</button>
                    </div>
                </div>

                <!-- ê°œì¸ì •ë³´ ìˆ˜ì • í¼ -->
                <div id="profileEditSection" style="display: none;">
                    <div class="profile-form-group">
                        <label class="profile-form-label" for="profileName">ì´ë¦„</label>
                        <input type="text" class="profile-input" id="profileName" readonly>
                        <div class="profile-error" id="profileNameError"></div>
                    </div>
                    
                    <div class="profile-form-group">
                        <label class="profile-form-label" for="profilePhone">íœ´ëŒ€í° ë²ˆí˜¸</label>
                        <input type="tel" class="profile-input" id="profilePhone" placeholder="010-0000-0000" readonly>
                        <div class="profile-error" id="profilePhoneError"></div>
                    </div>
                    
                    <div class="profile-form-group">
                        <label class="profile-form-label" for="profileNewPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="profile-input" id="profileNewPassword" placeholder="8-15ì, ì˜ë¬¸+ìˆ«ì ì¡°í•©">
                        <div class="profile-error" id="profileNewPasswordError"></div>
                    </div>
                    
                    <div class="profile-form-group">
                        <label class="profile-form-label" for="profileConfirmPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" class="profile-input" id="profileConfirmPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
                        <div class="profile-error" id="profileConfirmPasswordError"></div>
                    </div>
                    
                    <div class="profile-form-group">
                        <label class="profile-form-label" for="profileEmail">ì´ë©”ì¼</label>
                        <div class="input-with-button">
                            <input type="email" class="profile-input" id="profileEmail" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" readonly>
                            <button type="button" class="btn btn-small" onclick="openEmailModal()">ìˆ˜ì •í•˜ê¸°</button>
                        </div>
                        <div class="profile-error" id="profileEmailError"></div>
                    </div>
                    
                    <div class="profile-actions">
                        <button class="btn btn-primary" onclick="submitProfileForm()">ìˆ˜ì •</button>
                        <button class="btn btn-secondary" onclick="closeProfileModal()">ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì´ë©”ì¼ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="emailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ì´ë©”ì¼ ìˆ˜ì •</h3>
                <button class="modal-close" onclick="closeEmailModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="profile-form-group">
                    <label class="profile-form-label" for="emailModalInput">ìƒˆ ì´ë©”ì¼</label>
                    <input type="email" class="profile-input" id="emailModalInput" placeholder="example@email.com">
                    <div class="profile-error" id="emailModalError"></div>
                </div>
                <div class="profile-actions">
                    <button class="btn btn-primary" onclick="confirmEmailChange()">í™•ì¸</button>
                    <button class="btn btn-secondary" onclick="closeEmailModal()">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>



    <script>
        // ì„¤ì • ë“œë¡­ë‹¤ìš´ í† ê¸€
        function toggleSettings() {
            const dropdown = document.getElementById('settingsDropdown');
            dropdown.classList.toggle('show');
        }

        // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        document.addEventListener('click', function(e) {
            const settingsIcon = document.querySelector('.settings-icon');
            if (!settingsIcon.contains(e.target)) {
                document.getElementById('settingsDropdown').classList.remove('show');
            }
            
            // PIN ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            const pinModal = document.getElementById('pinModal');
            if (pinModal && pinModal.classList.contains('show')) {
                const modalContent = pinModal.querySelector('.modal-content');
                if (e.target === pinModal) {
                    closePinModal();
                }
            }
            
            // ì´ë©”ì¼ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            const emailModal = document.getElementById('emailModal');
            if (emailModal && emailModal.classList.contains('show')) {
                if (e.target === emailModal) {
                    closeEmailModal();
                }
            }
        });

        // PIN ê´€ë¦¬ ë³€ìˆ˜
        let currentPinMode = 'register'; // 'register' ë˜ëŠ” 'change'
        let userPinStatus = null;

        // ê³„ì¢Œ ê´€ë¦¬ í˜ì´ì§€ ì—´ê¸°
        function openAccountManagement() {
            console.log('ê³„ì¢Œ ê´€ë¦¬ í˜ì´ì§€ ì—´ê¸°');
            document.getElementById('settingsDropdown').classList.remove('show');
            window.location.href = '/account-management.html';
        }

        // PIN ì„¤ì • ì—´ê¸°
        async function openPinSettings() {
            console.log('PIN ì„¤ì • ì—´ê¸° ì‹œì‘');
            document.getElementById('settingsDropdown').classList.remove('show');
            
            // PIN ìƒíƒœ í™•ì¸
            await checkPinStatus();
            
            const pinModal = document.getElementById('pinModal');
            if (pinModal) {
                pinModal.classList.add('show');
                document.body.style.overflow = 'hidden';
                console.log('PIN ì„¤ì • ëª¨ë‹¬ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.');
            } else {
                console.error('PIN ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // PIN ìƒíƒœ í™•ì¸
        async function checkPinStatus() {
            console.log('PIN ìƒíƒœ í™•ì¸ ì‹œì‘');
            const token = localStorage.getItem('accessToken');
            
            if (!token) {
                console.error('í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                console.log('PIN ìƒíƒœ API í˜¸ì¶œ');
                const response = await fetch('/api/pin/status', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('PIN ìƒíƒœ ì‘ë‹µ:', response.status);
                const data = await response.json();
                console.log('PIN ìƒíƒœ ë°ì´í„°:', data);
                
                if (response.ok && data.success) {
                    userPinStatus = data;
                    updatePinModal(data);
                    console.log('PIN ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                } else {
                    console.error('PIN ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', data.message);
                    showPinError('PIN ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('PIN ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                showPinError('PIN ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // PIN ëª¨ë‹¬ ì—…ë°ì´íŠ¸
        function updatePinModal(pinStatus) {
            console.log('PIN ëª¨ë‹¬ ì—…ë°ì´íŠ¸ ì‹œì‘:', pinStatus);
            
            const statusInfo = document.getElementById('pinStatusInfo');
            const registerForm = document.getElementById('pinRegisterForm');
            const changeForm = document.getElementById('pinChangeForm');
            const submitBtn = document.getElementById('pinSubmitBtn');
            const modalTitle = document.getElementById('pinModalTitle');
            
            if (!statusInfo || !registerForm || !changeForm || !submitBtn || !modalTitle) {
                console.error('PIN ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (pinStatus.hasPinSet) {
                // PINì´ ì´ë¯¸ ì„¤ì •ëœ ê²½ìš°
                console.log('PINì´ ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                currentPinMode = 'change';
                modalTitle.textContent = 'PIN ë³€ê²½';
                statusInfo.textContent = 'PINì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ PINìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                statusInfo.className = 'pin-status-info has-pin';
                registerForm.style.display = 'none';
                changeForm.style.display = 'block';
                submitBtn.textContent = 'ë³€ê²½';
                
                if (pinStatus.isPinLocked) {
                    console.log('PINì´ ì ê¸ˆë˜ì—ˆìŠµë‹ˆë‹¤:', pinStatus.lockReason);
                    statusInfo.textContent = `PINì´ ì ê¸ˆë˜ì—ˆìŠµë‹ˆë‹¤: ${pinStatus.lockReason}`;
                    statusInfo.className = 'pin-status-info no-pin';
                    changeForm.style.display = 'none';
                    submitBtn.disabled = true;
                }
            } else {
                // PINì´ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš°
                console.log('PINì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                currentPinMode = 'register';
                modalTitle.textContent = 'PIN ë“±ë¡';
                statusInfo.textContent = 'PINì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë³´ì•ˆì„ ìœ„í•´ PINì„ ë“±ë¡í•´ì£¼ì„¸ìš”.';
                statusInfo.className = 'pin-status-info no-pin';
                registerForm.style.display = 'block';
                changeForm.style.display = 'none';
                submitBtn.textContent = 'ë“±ë¡';
                submitBtn.disabled = false;
            }
            
            console.log('PIN ëª¨ë‹¬ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }

        // PIN ëª¨ë‹¬ ë‹«ê¸°
        function closePinModal() {
            const pinModal = document.getElementById('pinModal');
            if (pinModal) {
                pinModal.classList.remove('show');
                document.body.style.overflow = '';
                
                // í¼ ì´ˆê¸°í™”
                clearPinForm();
                
                console.log('PIN ëª¨ë‹¬ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.');
            }
        }

        // PIN í¼ ì´ˆê¸°í™”
        function clearPinForm() {
            // ëª¨ë“  ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            const inputs = document.querySelectorAll('#pinModal input');
            inputs.forEach(input => {
                input.value = '';
            });
            
            // ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”
            const errors = document.querySelectorAll('#pinModal .pin-error');
            errors.forEach(error => {
                error.textContent = '';
            });
        }

        // PIN ì—ëŸ¬ í‘œì‹œ
        function showPinError(message) {
            const statusInfo = document.getElementById('pinStatusInfo');
            statusInfo.textContent = message;
            statusInfo.className = 'pin-status-info no-pin';
        }

        // PIN ì œì¶œ
        async function submitPin() {
            console.log('PIN ì œì¶œ ì‹œì‘ - ëª¨ë“œ:', currentPinMode);
            
            if (currentPinMode === 'register') {
                await registerPin();
            } else {
                await changePin();
            }
        }

        // PIN ë“±ë¡
        async function registerPin() {
            console.log('PIN ë“±ë¡ ì‹œì‘');
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPin = document.getElementById('newPin').value;
            const confirmPin = document.getElementById('confirmPin').value;
            
            console.log('ì…ë ¥ê°’ í™•ì¸:', {
                currentPassword: currentPassword ? 'ì…ë ¥ë¨' : 'ë¯¸ì…ë ¥',
                newPin: newPin ? 'ì…ë ¥ë¨' : 'ë¯¸ì…ë ¥',
                confirmPin: confirmPin ? 'ì…ë ¥ë¨' : 'ë¯¸ì…ë ¥'
            });
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!validatePinRegistration(currentPassword, newPin, confirmPin)) {
                console.log('PIN ë“±ë¡ ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨');
                return;
            }
            
            const token = localStorage.getItem('accessToken');
            console.log('í† í° ì¡´ì¬ ì—¬ë¶€:', !!token);
            
            try {
                console.log('PIN ë“±ë¡ API í˜¸ì¶œ ì‹œì‘');
                const response = await fetch('/api/pin/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        pin: newPin,
                        currentPassword: currentPassword
                    })
                });
                
                console.log('API ì‘ë‹µ ìƒíƒœ:', response.status);
                const data = await response.json();
                console.log('API ì‘ë‹µ ë°ì´í„°:', data);
                
                if (response.ok && data.success) {
                    console.log('PIN ë“±ë¡ ì„±ê³µ');
                    alert('PINì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closePinModal();
                } else {
                    console.log('PIN ë“±ë¡ ì‹¤íŒ¨:', data.message);
                    // ë¹„ë°€ë²ˆí˜¸ ê´€ë ¨ ì—ëŸ¬ì¸ ê²½ìš° í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í•„ë“œì— í‘œì‹œ
                    if (data.message && data.message.includes('ë¹„ë°€ë²ˆí˜¸')) {
                        showPinFormError('currentPassword', data.message);
                    } else {
                        showPinFormError('newPin', data.message || 'PIN ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            } catch (error) {
                console.error('PIN ë“±ë¡ ì˜¤ë¥˜:', error);
                showPinFormError('newPin', 'PIN ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // PIN ë³€ê²½
        async function changePin() {
            const currentPin = document.getElementById('currentPin').value;
            const newPin = document.getElementById('newPinChange').value;
            const confirmPin = document.getElementById('confirmPinChange').value;
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!validatePinChange(currentPin, newPin, confirmPin)) {
                return;
            }
            
            const token = localStorage.getItem('accessToken');
            
            try {
                const response = await fetch('/api/pin/change', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        currentPin: currentPin,
                        newPin: newPin
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('PINì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closePinModal();
                } else {
                    showPinFormError('currentPin', data.message || 'PIN ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('PIN ë³€ê²½ ì˜¤ë¥˜:', error);
                showPinFormError('currentPin', 'PIN ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // PIN ë“±ë¡ ìœ íš¨ì„± ê²€ì‚¬
        function validatePinRegistration(currentPassword, newPin, confirmPin) {
            console.log('PIN ë“±ë¡ ìœ íš¨ì„± ê²€ì‚¬ ì‹œì‘');
            clearPinFormErrors();
            
            let isValid = true;
            
            if (!currentPassword) {
                console.log('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ë¯¸ì…ë ¥');
                showPinFormError('currentPassword', 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                isValid = false;
            }
            
            if (!newPin || newPin.length !== 6 || !/^\d{6}$/.test(newPin)) {
                console.log('PIN í˜•ì‹ ì˜¤ë¥˜:', newPin);
                showPinFormError('newPin', 'PINì€ 6ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
                isValid = false;
            }
            
            if (newPin !== confirmPin) {
                console.log('PIN ë¶ˆì¼ì¹˜:', newPin, 'vs', confirmPin);
                showPinFormError('confirmPin', 'PINì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                isValid = false;
            }
            
            console.log('PIN ë“±ë¡ ìœ íš¨ì„± ê²€ì‚¬ ê²°ê³¼:', isValid);
            return isValid;
        }

        // PIN ë³€ê²½ ìœ íš¨ì„± ê²€ì‚¬
        function validatePinChange(currentPin, newPin, confirmPin) {
            clearPinFormErrors();
            
            let isValid = true;
            
            if (!currentPin || currentPin.length !== 6 || !/^\d{6}$/.test(currentPin)) {
                showPinFormError('currentPin', 'í˜„ì¬ PINì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                isValid = false;
            }
            
            if (!newPin || newPin.length !== 6 || !/^\d{6}$/.test(newPin)) {
                showPinFormError('newPinChange', 'PINì€ 6ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
                isValid = false;
            }
            
            if (currentPin === newPin) {
                showPinFormError('newPinChange', 'ìƒˆë¡œìš´ PINì€ í˜„ì¬ PINê³¼ ë‹¬ë¼ì•¼ í•©ë‹ˆë‹¤.');
                isValid = false;
            }
            
            if (newPin !== confirmPin) {
                showPinFormError('confirmPinChange', 'PINì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                isValid = false;
            }
            
            return isValid;
        }

        // PIN í¼ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        function showPinFormError(fieldName, message) {
            console.log('PIN í¼ ì—ëŸ¬ í‘œì‹œ:', fieldName, message);
            const errorElement = document.getElementById(fieldName + 'Error');
            if (errorElement) {
                errorElement.textContent = message;
                console.log('ì—ëŸ¬ ë©”ì‹œì§€ê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤:', message);
            } else {
                console.error('ì—ëŸ¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', fieldName + 'Error');
            }
        }

        // PIN í¼ ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”
        function clearPinFormErrors() {
            const errors = document.querySelectorAll('#pinModal .pin-error');
            errors.forEach(error => {
                error.textContent = '';
            });
        }

        // ì„ì‹œ ê³„ì • ì„¤ì • í•¨ìˆ˜ (ì¶”í›„ êµ¬í˜„)
        function openAccountSettings() {
            document.getElementById('settingsDropdown').classList.remove('show');
            openProfileModal();
        }

        // ê°œì¸ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function openProfileModal() {
            console.log('ê°œì¸ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°');
            document.getElementById('profileModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // ì´ˆê¸° ìƒíƒœë¡œ ì„¤ì • (ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì„¹ì…˜ í‘œì‹œ)
            document.getElementById('passwordCheckSection').style.display = 'block';
            document.getElementById('profileEditSection').style.display = 'none';
            
            // í¼ ì´ˆê¸°í™”
            clearProfileErrors();
            document.getElementById('profilePasswordCheck').value = '';
        }

        // ê°œì¸ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
        function closeProfileModal() {
            console.log('ê°œì¸ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°');
            document.getElementById('profileModal').classList.remove('show');
            document.body.style.overflow = '';
            clearProfileErrors();
            
            // ì„ì‹œ ì €ì¥ëœ ë°ì´í„° ì´ˆê¸°í™”
            tempEmailChange = null;
        }

        // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í›„ ê°œì¸ì •ë³´ ìˆ˜ì • í¼ í‘œì‹œ
        async function verifyPasswordForProfile() {
            console.log('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì‹œì‘');
            const password = document.getElementById('profilePasswordCheck').value;
            
            if (!password) {
                showProfileError('profilePasswordCheck', 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const token = localStorage.getItem('accessToken');
            
            try {
                const response = await fetch('/api/auth/verify-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    console.log('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì„±ê³µ');
                    // ê°œì¸ì •ë³´ ìˆ˜ì • í¼ í‘œì‹œ
                    document.getElementById('passwordCheckSection').style.display = 'none';
                    document.getElementById('profileEditSection').style.display = 'block';
                    
                    // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
                    await loadCurrentProfile();
                } else {
                    console.log('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì‹¤íŒ¨:', data.message);
                    showProfileError('profilePasswordCheck', data.message || 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì˜¤ë¥˜:', error);
                showProfileError('profilePasswordCheck', 'ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í˜„ì¬ í”„ë¡œí•„ ì •ë³´ ë¡œë“œ
        async function loadCurrentProfile() {
            console.log('í˜„ì¬ í”„ë¡œí•„ ì •ë³´ ë¡œë“œ');
            const token = localStorage.getItem('accessToken');
            
            try {
                const response = await fetch('/api/auth/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    console.log('í”„ë¡œí•„ ì •ë³´ ë¡œë“œ ì„±ê³µ:', data);
                    
                    // ì´ë¦„ì€ readonlyë¡œ ì„¤ì •
                    document.getElementById('profileName').value = data.name || '';
                    
                    // íœ´ëŒ€í°ë²ˆí˜¸ëŠ” í•˜ì´í”ˆ í¬í•¨í•˜ì—¬ ì„¤ì •
                    const phoneNumber = data.phoneNumber || '';
                    const formattedPhone = formatPhoneNumberForDisplay(phoneNumber);
                    document.getElementById('profilePhone').value = formattedPhone;
                    
                    // ì´ë©”ì¼ì€ í˜„ì¬ ê°’ìœ¼ë¡œ ì„¤ì •
                    document.getElementById('profileEmail').value = data.email || '';
                    
                    // ë¹„ë°€ë²ˆí˜¸ í•„ë“œëŠ” ì´ˆê¸°í™”
                    document.getElementById('profileNewPassword').value = '';
                    document.getElementById('profileConfirmPassword').value = '';
                    
                    // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    setupPasswordValidation();
                } else {
                    console.error('í”„ë¡œí•„ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', data.message);
                }
            } catch (error) {
                console.error('í”„ë¡œí•„ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // íœ´ëŒ€í°ë²ˆí˜¸ í‘œì‹œìš© í¬ë§·íŒ…
        function formatPhoneNumberForDisplay(phoneNumber) {
            if (!phoneNumber) return '';
            // í•˜ì´í”ˆì´ ì—†ëŠ” ê²½ìš° ì¶”ê°€
            if (phoneNumber.length === 11 && !phoneNumber.includes('-')) {
                return phoneNumber.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            }
            return phoneNumber;
        }

        // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupPasswordValidation() {
            const newPasswordInput = document.getElementById('profileNewPassword');
            const confirmPasswordInput = document.getElementById('profileConfirmPassword');
            
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', validateProfilePassword);
            }
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', validateProfileConfirmPassword);
            }
        }

        // ê°œì¸ì •ë³´ ìˆ˜ì • í¼ ì œì¶œ
        async function submitProfileForm() {
            console.log('ê°œì¸ì •ë³´ ìˆ˜ì • í¼ ì œì¶œ');
            
            const name = document.getElementById('profileName').value.trim();
            const newPassword = document.getElementById('profileNewPassword').value;
            const confirmPassword = document.getElementById('profileConfirmPassword').value;
            const email = tempEmailChange || document.getElementById('profileEmail').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();

            // ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì—¬ë¶€ì— ë”°ë¥¸ ê²€ì¦
            if (newPassword || confirmPassword) {
                if (!validatePasswordChange(newPassword, confirmPassword)) {
                    return;
                }
            } else {
                // ë‘˜ ë‹¤ ë¹ˆ ê²½ìš°ëŠ” ì •ìƒ ì²˜ë¦¬
                // ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥ëœ ê²½ìš° ì˜¤ë¥˜
                if ((newPassword && !confirmPassword) || (!newPassword && confirmPassword)) {
                    if (newPassword && !confirmPassword) {
                        showProfileError('profileConfirmPasswordError', 'ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        document.getElementById('profileConfirmPassword').focus();
                    } else {
                        showProfileError('profileNewPasswordError', 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        document.getElementById('profileNewPassword').focus();
                    }
                    return;
                }
            }

            // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬ (ë³€ê²½ëœ ê²½ìš°ì—ë§Œ)
            if (tempEmailChange && !isValidEmail(tempEmailChange)) {
                showProfileError('profileEmailError', 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                return;
            }

            const profileData = {
                name: name || null,
                newPassword: newPassword || null,
                email: tempEmailChange || null, // ì„ì‹œ ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ì‚¬ìš©
                phoneNumber: null // íœ´ëŒ€í°ë²ˆí˜¸ëŠ” ìˆ˜ì • ë¶ˆê°€
            };

            console.log('ì „ì†¡í•  ë°ì´í„°:', profileData);

            try {
                const response = await fetch('/api/auth/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                    },
                    body: JSON.stringify(profileData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.message) {
                    console.log('ê°œì¸ì •ë³´ ìˆ˜ì • ì„±ê³µ');
                    alert('ê°œì¸ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeProfileModal();
                    
                    // ì‚¬ìš©ì ì´ë¦„ ì—…ë°ì´íŠ¸
                    if (name) {
                        document.getElementById('userName').textContent = name;
                    }
                } else {
                    console.log('ê°œì¸ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨:', data.message);
                    alert('ê°œì¸ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ê°œì¸ì •ë³´ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('ê°œì¸ì •ë³´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìœ íš¨ì„± ê²€ì‚¬
        function validatePasswordChange(newPassword, confirmPassword) {
            clearProfileErrors();
            let isValid = true;

            if (newPassword && !confirmPassword) {
                showProfileError('profileConfirmPasswordError', 'ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                isValid = false;
            }

            if (!newPassword && confirmPassword) {
                showProfileError('profileNewPasswordError', 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                isValid = false;
            }

            if (newPassword && confirmPassword) {
                if (!isValidProfilePassword(newPassword)) {
                    showProfileError('profileNewPasswordError', '8-15ì, ì˜ë¬¸+ìˆ«ì ì¡°í•©ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    isValid = false;
                }

                if (newPassword !== confirmPassword) {
                    showProfileError('profileConfirmPasswordError', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    isValid = false;
                }
            }

            return isValid;
        }

        // í”„ë¡œí•„ ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬ (8-15ì, ì˜ë¬¸+ìˆ«ì ì¡°í•©)
        function isValidProfilePassword(password) {
            if (password.length < 8) {
                return false;
            }
            if (password.length > 15) {
                return false;
            }
            const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,15}$/;
            return passwordRegex.test(password);
        }

        // í”„ë¡œí•„ ìƒˆ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
        function validateProfilePassword() {
            const password = document.getElementById('profileNewPassword').value;
            const statusElement = document.getElementById('profileNewPasswordError');
            
            if (!password) {
                statusElement.textContent = '';
                statusElement.className = 'profile-error';
                return;
            }
            
            if (isValidProfilePassword(password)) {
                statusElement.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.';
                statusElement.className = 'profile-error success';
            } else {
                if (password.length < 8) {
                    statusElement.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                } else if (password.length > 15) {
                    statusElement.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 15ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.';
                } else {
                    statusElement.textContent = '8-15ì, ì˜ë¬¸+ìˆ«ì ì¡°í•©ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                }
                statusElement.className = 'profile-error error';
            }
            
            // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ë„ ë‹¤ì‹œ ê²€ì¦
            validateProfileConfirmPassword();
        }

        // í”„ë¡œí•„ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ê²€ì¦
        function validateProfileConfirmPassword() {
            const password = document.getElementById('profileNewPassword').value;
            const confirmPassword = document.getElementById('profileConfirmPassword').value;
            const statusElement = document.getElementById('profileConfirmPasswordError');
            
            if (!confirmPassword) {
                statusElement.textContent = '';
                statusElement.className = 'profile-error';
                return;
            }
            
            if (password === confirmPassword) {
                statusElement.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.';
                statusElement.className = 'profile-error success';
            } else {
                statusElement.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                statusElement.className = 'profile-error error';
            }
        }

        // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // ê°œì¸ì •ë³´ ìˆ˜ì • ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        function showProfileError(fieldName, message) {
            const errorElement = document.getElementById(fieldName + 'Error');
            if (errorElement) {
                errorElement.textContent = message;
            }
        }

        // ê°œì¸ì •ë³´ ìˆ˜ì • ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”
        function clearProfileErrors() {
            const errors = document.querySelectorAll('#profileModal .profile-error, #emailModal .profile-error');
            errors.forEach(error => {
                error.textContent = '';
            });
        }



                 // PIN ë“±ë¡ ê°•ì œ ì²´í¬
        function checkPinRequired() {
            console.log('=== PIN ë“±ë¡ í•„ìš” ì—¬ë¶€ í™•ì¸ ì‹œì‘ ===');
            console.log('í˜„ì¬ ì‹œê°„:', new Date().toLocaleString());
            
            const token = localStorage.getItem('accessToken');
            console.log('í† í° ì¡´ì¬ ì—¬ë¶€:', !!token);
            console.log('í† í° ê¸¸ì´:', token ? token.length : 0);
            
            if (!token) {
                console.log('í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            console.log('API í˜¸ì¶œ ì‹œì‘: /auth/check-pin-required');
            
            fetch('/api/auth/check-pin-required', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('=== API ì‘ë‹µ ì •ë³´ ===');
                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
                console.log('ì‘ë‹µ ìƒíƒœ í…ìŠ¤íŠ¸:', response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('=== ì‘ë‹µ ë°ì´í„° ===');
                console.log('ì „ì²´ ì‘ë‹µ:', data);
                console.log('pinRequired ê°’:', data.pinRequired);
                
                if (data.pinRequired) {
                    console.log('PIN ë“±ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤. ëª¨ë‹¬ì„ ì—´ê² ìŠµë‹ˆë‹¤.');
                    
                    // PIN ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
                    openPinModalForRegistration();
                } else {
                    console.log('PINì´ ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('=== PIN ì²´í¬ ì˜¤ë¥˜ ===');
                console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
                console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
            });
        }

        // PIN ë“±ë¡ì„ ìœ„í•œ ëª¨ë‹¬ ì—´ê¸°
        function openPinModalForRegistration() {
            const pinModal = document.getElementById('pinModal');
            console.log('PIN ëª¨ë‹¬ ìš”ì†Œ:', pinModal);
            
            if (pinModal) {
                // PIN ë“±ë¡ í™”ë©´ìœ¼ë¡œ ì„¤ì •
                currentPinMode = 'register';
                document.getElementById('pinModalTitle').textContent = 'PIN ë“±ë¡';
                document.getElementById('pinStatusInfo').textContent = 'PINì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë³´ì•ˆì„ ìœ„í•´ PINì„ ë“±ë¡í•´ì£¼ì„¸ìš”.';
                document.getElementById('pinStatusInfo').className = 'pin-status-info no-pin';
                document.getElementById('pinRegisterForm').style.display = 'block';
                document.getElementById('pinChangeForm').style.display = 'none';
                document.getElementById('pinSubmitBtn').textContent = 'ë“±ë¡';
                document.getElementById('pinSubmitBtn').disabled = false;
                
                // ëª¨ë‹¬ í‘œì‹œ
                pinModal.classList.add('show');
                document.body.style.overflow = 'hidden';
                
                console.log('PIN ë“±ë¡ ëª¨ë‹¬ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.');
                console.log('ëª¨ë‹¬ show í´ë˜ìŠ¤:', pinModal.classList.contains('show'));
            } else {
                console.error('PIN ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ PIN ë“±ë¡ í•„ìš” ì—¬ë¶€ í™•ì¸
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ===');
            console.log('DOMì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. PIN ì²´í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.');
            
            // ì ì‹œ í›„ PIN ì²´í¬ ì‹¤í–‰ (í˜ì´ì§€ ë Œë”ë§ ì™„ë£Œ í›„)
            setTimeout(() => {
                console.log('PIN ì²´í¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤...');
                checkPinRequired();
            }, 1000);
            
            // ìˆ«ìë§Œ ì…ë ¥ í—ˆìš©
            const pinInputs = document.querySelectorAll('#newPin, #confirmPin, #currentPin, #newPinChange, #confirmPinChange');
            
            pinInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    // ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ì ì œê±°
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    
                    // 6ìë¦¬ ì œí•œ
                    if (e.target.value.length > 6) {
                        e.target.value = e.target.value.slice(0, 6);
                    }
                });
            });
        });

        // ì„ì‹œ ë³´ì•ˆ ì„¤ì • í•¨ìˆ˜ (ì¶”í›„ êµ¬í˜„)
        function openSecuritySettings() {
            document.getElementById('settingsDropdown').classList.remove('show');
            alert('ë³´ì•ˆ ì„¤ì • ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
        }

        // ì´ë©”ì¼ ìˆ˜ì • ëª¨ë‹¬ ê´€ë ¨ ë³€ìˆ˜
        let tempEmailChange = null;

        // ì´ë©”ì¼ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function openEmailModal() {
            const emailModal = document.getElementById('emailModal');
            const emailInput = document.getElementById('emailModalInput');
            const currentEmail = document.getElementById('profileEmail').value;
            
            // í˜„ì¬ ì´ë©”ì¼ë¡œ ì´ˆê¸°í™”
            emailInput.value = currentEmail;
            document.getElementById('emailModalError').textContent = '';
            
            emailModal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // ì´ë©”ì¼ ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
        function closeEmailModal() {
            const emailModal = document.getElementById('emailModal');
            emailModal.classList.remove('show');
            document.body.style.overflow = '';
            
            // ì„ì‹œ ë³€ê²½ì‚¬í•­ ì´ˆê¸°í™”
            tempEmailChange = null;
        }

        // ì´ë©”ì¼ ë³€ê²½ í™•ì¸
        async function confirmEmailChange() {
            const email = document.getElementById('emailModalInput').value.trim();
            const errorElement = document.getElementById('emailModalError');
            
            // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
            if (!email) {
                errorElement.textContent = 'ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                errorElement.className = 'profile-error error';
                return;
            }
            
            if (!isValidEmail(email)) {
                errorElement.textContent = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (@ í¬í•¨)';
                errorElement.className = 'profile-error error';
                return;
            }
            
            // ì¤‘ë³µ ê²€ì‚¬
            try {
                const response = await fetch(`/api/auth/check-email?email=${encodeURIComponent(email)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    // ì„±ê³µ: ì„ì‹œ ë³€ê²½ì‚¬í•­ ì €ì¥
                    tempEmailChange = email;
                    
                    // ë¶€ëª¨ í¼ì— ë°˜ì˜
                    document.getElementById('profileEmail').value = email;
                    
                    // ëª¨ë‹¬ ë‹«ê¸°
                    closeEmailModal();
                    
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    showProfileError('profileEmailError', 'ì´ë©”ì¼ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    setTimeout(() => {
                        document.getElementById('profileEmailError').textContent = '';
                    }, 3000);
                } else if (response.status === 409) {
                    errorElement.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                    errorElement.className = 'profile-error error';
                } else {
                    errorElement.textContent = data.message || 'ì´ë©”ì¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    errorElement.className = 'profile-error error';
                }
            } catch (error) {
                console.error('Email check error:', error);
                errorElement.textContent = 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                errorElement.className = 'profile-error error';
            }
        }

        // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬ (íšŒì›ê°€ì…ê³¼ ë™ì¼)
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
    </script>
</body>
</html> 